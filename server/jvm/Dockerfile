FROM centos:centos7.9.2009 as base

RUN ["/bin/bash", "-c", "rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY*"]
RUN ["/bin/bash", "-c", "echo 'y' | yum install unzip"]
RUN ["/bin/bash", "-c", "echo 'y' | yum install java-11-openjdk-devel"]
RUN ["/bin/bash", "-c", "echo 'y' | yum install openssh-server"]
RUN if [ $(uname -m) = "x86_64" ] ; then (echo 'y' | yum install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm) \
    ; else (echo 'y' | yum install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-aarch64/pgdg-redhat-repo-latest.noarch.rpm) ; fi
RUN ["/bin/bash", "-c", "echo 'y' | yum install -y --nogpgcheck postgresql14-server"]
RUN if [ $(uname -m) = "aarch64" ] ; then yum -y install epel-release ; fi
RUN if [ $(uname -m) = "aarch64" ] ; then yum -y install lmdb ; fi
RUN if [ $(uname -m) = "aarch64" ] ; then ln -s /usr/lib64/liblmdb.so.0.0.0 /usr/lib64/liblmdb.so ; fi
RUN ["/bin/bash", "-c", "useradd alpha"]
RUN ["/bin/bash", "-c", "echo alpha:alpha | chpasswd"]
RUN ["/bin/bash", "-c", "usermod -aG wheel alpha"]
RUN ["/bin/bash", "-c", "mkdir /home/alpha/run"]
RUN ["/bin/bash", "-c", "mv /usr/bin/systemctl /usr/bin/systemctl.old"]
RUN ["/bin/bash", "-c", "curl https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl.py > /usr/bin/systemctl"]
RUN ["/bin/bash", "-c", "chmod +x /usr/bin/systemctl"]
RUN ["/bin/bash", "-c", "/usr/bin/ssh-keygen -A"]

FROM base as copy-distributions

WORKDIR /home/alpha/run/
COPY ./build/dependencies/genesisproduct*.zip .
COPY ./build/dependencies/genesis-distribution*.zip .
COPY ./build/dependencies/alpha-site-specific*.zip .
COPY ./build/dependencies/auth-distribution-*.zip .

RUN unzip \*.zip
RUN rm *.zip
RUN ["/bin/bash", "-c", "chown -hR alpha:alpha ../run/"]

FROM copy-distributions as setup-genesis

RUN echo "GENESIS_HOME=/home/alpha/run/" >> /home/alpha/.bashrc
RUN echo "export GENESIS_HOME" >> /home/alpha/.bashrc
RUN echo "source \$GENESIS_HOME/genesis/util/setup.sh" >> /home/alpha/.bashrc

FROM setup-genesis as configure-db
COPY docker-scripts/configureDB.sh /scripts/configureDB.sh
RUN ["chmod", "+x", "/scripts/configureDB.sh"]
RUN ["/scripts/configureDB.sh"]

FROM configure-db as genesis-install
COPY docker-scripts/genesisInstall.sh /scripts/genesisInstall.sh
RUN ["chmod", "+x", "/scripts/genesisInstall.sh"]
RUN ["/scripts/genesisInstall.sh"]

FROM genesis-install as remap
COPY docker-scripts/remap.sh /scripts/remap.sh
RUN ["chmod", "+x", "/scripts/remap.sh"]
RUN ["/scripts/remap.sh"]

FROM remap as loaddata
COPY docker-scripts/loaddata.sh /scripts/loaddata.sh
RUN ["chmod", "+x", "/scripts/loaddata.sh"]
RUN ["/scripts/loaddata.sh"]

FROM loaddata as entryPoint
COPY docker-scripts/docker-entrypoint.sh /scripts/docker-entrypoint.sh
RUN chmod +x /scripts/docker-entrypoint.sh
ENTRYPOINT ["/scripts/docker-entrypoint.sh"]
